{"version":3,"file":"action.js","sources":["../src/action.ts"],"sourcesContent":["import Action from \"@actions/core\";\nimport GitHub from \"@actions/github\";\nimport Path from \"path\";\nimport { AppInstanceId, DeploymentManager, HostConfig, parseAppInstanceId, parseReleaseId, ReleaseId } from \"./core\";\nimport { Exception, importJSON } from \"./core/helpers\";\n\ninterface Command {\n  action: string;\n}\n\ninterface CreateReleaseCommand extends Command {\n  action: \"create-release\";\n  app: string;\n  commit: string;\n  tag: string;\n  artefact: string;\n}\n\ninterface CreateInstanceCommand extends Command {\n  action: \"create-instance\";\n  app: string;\n  releaseId: ReleaseId;\n}\n\ninterface DestroyInstanceCommand extends Command {\n  action: \"destroy-instance\";\n  app: string;\n  instanceId: AppInstanceId;\n}\n\ninterface PromoteInstanceCommand extends Command {\n  action: \"promote-instance\";\n  app: string;\n  instanceId: AppInstanceId;\n}\n\nfunction getCommand(): CreateInstanceCommand | CreateReleaseCommand | PromoteInstanceCommand | DestroyInstanceCommand {\n  const action = Action.getInput(\"action\", { required: true });\n  switch (action) {\n    case \"create-release\":\n      return {\n        action,\n        app: Action.getInput(\"app\", { required: true }),\n        commit: Action.getInput(\"commit\") ?? GitHub.context.sha,\n        tag: Action.getInput(\"tag\") ?? \"latest\",\n        artefact: Action.getInput(\"artefact\") ?? process.cwd(),\n      };\n    case \"create-instance\":\n      return {\n        action,\n        app: Action.getInput(\"app\", { required: true }),\n        releaseId: parseReleaseId(Action.getInput(\"release_id\", { required: true })),\n      };\n    case \"promote-instance\":\n    case \"destroy-instance\":\n      return {\n        action,\n        app: Action.getInput(\"app\", { required: true }),\n        instanceId: parseAppInstanceId(Action.getInput(\"instance_id\", { required: true })),\n      };\n    default:\n      throw new Error(`Unknown action: ${action}`);\n  }\n}\n\nasync function main(): Promise<void> {\n  const workingDir = process.cwd();\n  const configFile = Path.resolve(workingDir, Action.getInput(\"deploy_config\") ?? \"deploy.json\");\n  const contents = await importJSON<HostConfig | HostConfig[]>(configFile);\n  const config = Array.isArray(contents) ? contents[0] : contents;\n  const command = getCommand();\n\n  const server = new DeploymentManager(config);\n\n  switch (command.action) {\n    case \"create-release\": {\n      const app = await server.connect(command.app);\n      const release = await app.createRelease(command, command.artefact);\n\n      Action.info(`Created release v${release.id} from ${release.commit} (tag: ${release.tag}).`);\n      Action.setOutput(\"release_id\", release.id);\n      break;\n    }\n\n    case \"create-instance\": {\n      const app = await server.connect(command.app);\n      const instance = await app.createInstance(command.releaseId);\n\n      Action.info(`Created instance ${instance.id} from release v${instance.releaseId}.`);\n      Action.setOutput(\"instance_id\", instance.id);\n      Action.setOutput(\"preview_url\", instance.preview);\n      break;\n    }\n\n    case \"promote-instance\": {\n      const app = await server.connect(command.app);\n      const status = await app.deploy(command.instanceId);\n\n      Action.info(`Deployed instance ${status.active} to production.`);\n      break;\n    }\n\n    case \"destroy-instance\": {\n      const app = await server.connect(command.app);\n      if (command.instanceId === app.app.deployments.active) throw Exception;\n      await app.destroyInstance(command.instanceId);\n\n      Action.info(`Deleted instance ${command.instanceId}.`);\n      break;\n    }\n  }\n}\n\nmain().catch((error) => {\n  Action.error(error);\n  process.exit(Action.ExitCode.Failure);\n});\n"],"names":["Action","GitHub","parseReleaseId","parseAppInstanceId","Path","importJSON","DeploymentManager","Exception"],"mappings":"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"}